name: CI Perf Check

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  perf-check:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r cenop/requirements.txt
          python -m pip install -e ./cenop

      - name: Warmup Numba (pre-compile)
        run: |
          python scripts/warmup_numba.py

      - name: Run short benchmark
        id: bench
        run: |
          python scripts/ci_benchmark.py --ticks 500 --porpoise 500 --baseline ci/perf/short_run_baseline.json
        continue-on-error: false

      - name: Upload benchmark artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ci-perf-artifacts
          path: |
            benchmark_result.json
            ci_instrumented_log.txt
            ci_instrumented_stdout.txt
            ci/perf/perf_history.csv

      - name: Post perf summary as PR comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs')
            if (fs.existsSync('benchmark_result.json')) {
              const data = JSON.parse(fs.readFileSync('benchmark_result.json', 'utf8'))
              const body = `**Perf check**\n- ticks: ${data.ticks}\n- porpoise: ${data.porpoise}\n- elapsed: ${data.elapsed.toFixed(2)}s\n- baseline: ${data.baseline_elapsed || 'n/a'}\n- threshold: ${data.threshold || 'n/a'}\n- regression: ${data.regression ? 'YES' : 'NO'}`
              github.rest.issues.createComment({owner: context.repo.owner, repo: context.repo.repo, issue_number: context.payload.pull_request.number, body})
            }

      - name: Print results
        if: always()
        run: |
          echo "Benchmark result contents:" && cat benchmark_result.json || true
